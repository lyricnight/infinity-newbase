package club.lyric.infinity.impl.modules.exploit;

import club.lyric.infinity.api.module.Category;
import club.lyric.infinity.api.module.ModuleBase;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Box;
import net.minecraft.util.math.Direction;
import net.minecraft.util.math.Vec3d;

/**
 * <a href=https://github.com/mioclient/hitbox-desync>https://github.com/mioclient/hitbox-desync</a>
 *
 * @author cattyngmd
 */
public final class HitboxDesync extends ModuleBase {
    private static final double MAGIC_OFFSET = .200009968835369999878673424677777777777761;

    public HitboxDesync() {
        super("HitboxDesync", "Prevents some crystalauras from working.", Category.Exploit);
    }

    @Override
    public void onEnable() {
        if (mc.world == null) {
            return;
        }

        if (mc.player == null) {
            this.setEnabled(false);
            return;
        }

        Direction facing = mc.player.getHorizontalFacing();
        Box bb = mc.player.getBoundingBox();
        Vec3d center = bb.getCenter();
        Vec3d offset = new Vec3d(facing.getUnitVector());

        Vec3d fin = merge(
                Vec3d.of(BlockPos.ofFloored(center)).add(.5, 0, .5).add(offset.multiply(MAGIC_OFFSET)),
                facing
        );

        mc.player.setPosition(fin.x == 0 ? mc.player.getX() : fin.x,
                mc.player.getY(),
                fin.z == 0 ? mc.player.getZ() : fin.z
        );

        setEnabled(false);
    }

    private Vec3d merge(Vec3d vec, Direction facing) {
        return new Vec3d(vec.x * Math.abs(facing.getUnitVector().x()),
                vec.y * Math.abs(facing.getUnitVector().y()),
                vec.z * Math.abs(facing.getUnitVector().z())
        );
    }
}